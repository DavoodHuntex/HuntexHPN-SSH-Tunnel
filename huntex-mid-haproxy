#!/usr/bin/env bash
set -Eeuo pipefail

# ============================================================
#  HUNTEX MID HAProxy — PASS-THROUGH (Silver + Mustard)
#  Client → IRAN:PORT → (SSH) → MID:PORT → OUT:PORT → Xray
#
#  Usage (GitHub RAW):
#    curl -fsSL https://raw.githubusercontent.com/<YOU>/Huntex-mid-haproxy/main/mid-install.sh | \
#      OUT_IP="X.X.X.X" PORT="443" bash
#
#  Required env:
#    OUT_IP   : OUT server IP (panel/xray)
#    PORT     : same port for listen + forward (e.g. 443 or 2053)
#
#  Optional env:
#    BIND_ADDR  : default 0.0.0.0
# ============================================================

# -------------------- UI (Silver + Mustard) --------------------
_have_tty()  { [[ -t 1 ]]; }
_have_tput() { command -v tput >/dev/null 2>&1; }

# Full terminal reset (not clear)
_full_reset_screen() {
  # only if running in a real terminal
  if _have_tty; then
    printf '\033c'
  fi
}

if _have_tty && _have_tput; then
  SILVER="$(tput setaf 7)"     # silver/white
  MUSTARD="$(tput setaf 3)"    # mustard/yellow-ish
  DIM="$(tput dim)"
  BOLD="$(tput bold)"
  RESET="$(tput sgr0)"
else
  SILVER=""; MUSTARD=""; DIM=""; BOLD=""; RESET=""
fi

_hr() { printf "%s\n" "${DIM}${SILVER}────────────────────────────────────────────────────────────${RESET}"; }
_box() {
  local title="$1" subtitle="$2"
  title="${title:-"No Title"}"
  subtitle="${subtitle:-"No Subtitle"}"

  _hr
  printf "%s┌──────────────────────────────────────────────────────────┐%s\n" "${DIM}${SILVER}" "${RESET}"
  printf "%s│%s %s%s%s%*s%s│%s\n" \
    "${DIM}${SILVER}" "${RESET}" \
    "${BOLD}${MUSTARD}${title}${RESET}" \
    "$((58 - ${#title}))" "" \
    "${DIM}${SILVER}" "${RESET}"
  printf "%s│%s %s%s%*s%s│%s\n" \
    "${DIM}${SILVER}" "${RESET}" \
    "${DIM}${SILVER}${subtitle}${RESET}" \
    "$((58 - ${#subtitle}))" "" \
    "${DIM}${SILVER}" "${RESET}"
  printf "%s└──────────────────────────────────────────────────────────┘%s\n" "${DIM}${SILVER}" "${RESET}"
  _hr
}

ok()   { printf "%s✅%s %s\n" "${BOLD}${MUSTARD}" "${RESET}" "$*"; }
warn() { printf "%s⚠️ %s%s\n" "${BOLD}${MUSTARD}" "$*" "${RESET}" >&2; }
err()  { printf "%s❌ %s%s\n" "${BOLD}${MUSTARD}" "$*" "${RESET}" >&2; }
die()  { err "$*"; exit 1; }

phase() {
  printf "%s%s▶%s %s%s%s\n" "${DIM}${SILVER}" "" "${RESET}" "${BOLD}${MUSTARD}" "$*" "${RESET}"
}

need_root() { [[ "${EUID:-0}" -eq 0 ]] || die "Run as root (sudo)."; }

# -------------------- Inputs --------------------
OUT_IP="${OUT_IP:-}"
PORT="${PORT:-}"
BIND_ADDR="${BIND_ADDR:-0.0.0.0}"

# -------------------- Paths --------------------
CFG="/etc/haproxy/haproxy.cfg"
CFG_BAK_DIR="/etc/haproxy/.bak"
SYSCTL="/etc/sysctl.d/99-huntex-mid-haproxy.conf"
OVR_DIR="/etc/systemd/system/haproxy.service.d"
OVR="${OVR_DIR}/override.conf"

# -------------------- Helpers --------------------
is_ipv4() { [[ "$1" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]; }
is_port() { [[ "$1" =~ ^[0-9]+$ ]] && (( 1 <= 10#$1 && 10#$1 <= 65535 )); }

get_nproc() {
  local n
  n="$(getconf _NPROCESSORS_ONLN 2>/dev/null || nproc 2>/dev/null || echo 1)"
  [[ "$n" =~ ^[0-9]+$ ]] || n=1
  (( n < 1 )) && n=1
  echo "$n"
}

get_mem_mib() {
  local mib
  mib="$(awk '/MemTotal:/ {printf "%.0f\n",$2/1024}' /proc/meminfo 2>/dev/null || echo 512)"
  [[ "$mib" =~ ^[0-9]+$ ]] || mib=512
  (( mib < 256 )) && mib=256
  echo "$mib"
}

get_ulimit_nofile() {
  local n
  n="$(ulimit -n 2>/dev/null || echo 1024)"
  [[ "$n" =~ ^[0-9]+$ ]] || n=1024
  (( n < 1024 )) && n=1024
  echo "$n"
}

calc_maxconn() {
  local target_nofile="$1" mem_mib="$2"
  local fd_budget maxconn_fd maxconn_ram maxconn

  fd_budget=$(( target_nofile - 2048 ))
  (( fd_budget < 2000 )) && fd_budget=2000
  maxconn_fd=$(( fd_budget / 2 ))
  maxconn_ram=$(( mem_mib * 20 ))

  maxconn="$maxconn_fd"
  (( maxconn > maxconn_ram )) && maxconn="$maxconn_ram"
  (( maxconn > 200000 )) && maxconn=200000
  (( maxconn < 2000 )) && maxconn=2000

  echo "$maxconn"
}

calc_nbthread() {
  local cpu="$1" nb="$cpu"
  (( nb < 1 )) && nb=1
  (( nb > 8 )) && nb=8
  echo "$nb"
}

calc_target_nofile() {
  local current="$1"
  local target="$current"
  (( target < 65535 )) && target=65535
  (( target > 1048576 )) && target=1048576
  echo "$target"
}

build_cpu_map_line() {
  local nbthread="$1" cpu="$2"
  local map_n="$nbthread"
  (( map_n > cpu )) && map_n="$cpu"
  if (( map_n >= 1 )); then
    echo "    cpu-map 1/1-${map_n} 0-$((map_n-1))"
  else
    echo ""
  fi
}

install_pkgs() {
  export DEBIAN_FRONTEND=noninteractive
  apt-get update -y >/dev/null 2>&1 || true
  apt-get install -y haproxy ca-certificates iproute2 procps coreutils >/dev/null 2>&1 || true
  command -v haproxy >/dev/null 2>&1 || die "haproxy not installed"
}

backup_cfg() {
  mkdir -p "$CFG_BAK_DIR"
  if [[ -f "$CFG" ]]; then
    cp -a "$CFG" "$CFG_BAK_DIR/haproxy.cfg.$(date +%s).bak" || true
  fi
}

apply_sysctl_safe() {
  cat >"$SYSCTL" <<'EOF'
# Huntex MID HAProxy safe TCP tuning (pass-through)
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 16384
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.ip_local_port_range = 10240 65535
net.ipv4.tcp_fin_timeout = 15
net.ipv4.tcp_tw_reuse = 1

# Keepalive (safe)
net.ipv4.tcp_keepalive_time = 60
net.ipv4.tcp_keepalive_intvl = 10
net.ipv4.tcp_keepalive_probes = 6
EOF
  sysctl --system >/dev/null 2>&1 || true
}

apply_systemd_limits() {
  local nofile="$1"
  mkdir -p "$OVR_DIR"
  cat >"$OVR" <<EOF
[Service]
LimitNOFILE=${nofile}
TasksMax=infinity
EOF
  systemctl daemon-reload
}

port_conflict_check() {
  if command -v ss >/dev/null 2>&1; then
    if ss -lntH "sport = :${PORT}" 2>/dev/null | grep -q .; then
      warn "Something is already LISTEN on :${PORT}. If it's not HAProxy, stop it first."
    fi
  fi
}

write_cfg() {
  local nbthread="$1" maxconn="$2" cpu_map_line="$3"

  cat >"$CFG" <<EOF
global
    log /dev/log local0
    log /dev/log local1 notice
    daemon

    nbthread ${nbthread}
${cpu_map_line}
    maxconn ${maxconn}

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    option  tcpka

    timeout connect 5s
    timeout client  2m
    timeout server  2m
    timeout tunnel  2m

frontend fe_mid_in
    bind ${BIND_ADDR}:${PORT}
    mode tcp
    default_backend be_out

backend be_out
    mode tcp
    option tcp-check
    default-server inter 2s fall 2 rise 2 on-marked-down shutdown-sessions
    server out1 ${OUT_IP}:${PORT} check
EOF
}

validate_cfg() { haproxy -c -f "$CFG" >/dev/null 2>&1; }
start_haproxy() { systemctl enable haproxy >/dev/null 2>&1 || true; systemctl restart haproxy; }

verify_listen() {
  if ss -lntp 2>/dev/null | grep -qE ":${PORT}\b"; then
    ss -lntp 2>/dev/null | grep -E ":${PORT}\b" || true
    return 0
  fi
  return 1
}

# -------------------- main --------------------
main() {
  need_root
  _full_reset_screen

  [[ -n "$OUT_IP" ]] || die "OUT_IP is required. Example: OUT_IP=\"1.2.3.4\""
  [[ -n "$PORT"   ]] || die "PORT is required. Example: PORT=\"443\""
  is_ipv4 "$OUT_IP"  || die "OUT_IP looks invalid: $OUT_IP"
  is_port "$PORT"    || die "PORT invalid/out of range: $PORT"

  # ✅ FIX: proper BIND_ADDR validation (NO function call inside [[ ... ]])
  if [[ "$BIND_ADDR" == "0.0.0.0" || "$BIND_ADDR" == "127.0.0.1" ]] || is_ipv4 "$BIND_ADDR"; then
    : # ok
  else
    die "BIND_ADDR invalid: $BIND_ADDR"
  fi

  _box "HUNTEX MID HAProxy" "PASS-THROUGH + AutoTune (Silver + Mustard)"
  printf "%s%s• OUT:%s %s:%s\n" "${SILVER}${DIM}" "" "${RESET}" "${SILVER}${OUT_IP}${RESET}" "${MUSTARD}${PORT}${RESET}"
  printf "%s%s• MID bind:%s %s:%s\n" "${SILVER}${DIM}" "" "${RESET}" "${SILVER}${BIND_ADDR}${RESET}" "${MUSTARD}${PORT}${RESET}"
  _hr

  phase "Phase 0 — Packages"
  install_pkgs
  ok "haproxy installed"

  phase "Phase 1 — AutoTune (CPU/RAM/NOFILE)"
  local CPU MEM_MIB ULIM_NOFILE TARGET_NOFILE NBTHREAD MAXCONN CPU_MAP_LINE
  CPU="$(get_nproc)"
  MEM_MIB="$(get_mem_mib)"
  ULIM_NOFILE="$(get_ulimit_nofile)"
  TARGET_NOFILE="$(calc_target_nofile "$ULIM_NOFILE")"
  NBTHREAD="$(calc_nbthread "$CPU")"
  MAXCONN="$(calc_maxconn "$TARGET_NOFILE" "$MEM_MIB")"
  CPU_MAP_LINE="$(build_cpu_map_line "$NBTHREAD" "$CPU")"
  ok "cpu=${CPU}, ram=${MEM_MIB}MiB, nbthread=${NBTHREAD}, maxconn=${MAXCONN}, nofile=${TARGET_NOFILE}"

  phase "Phase 2 — Safe kernel tuning (sysctl)"
  apply_sysctl_safe
  ok "sysctl applied: ${SYSCTL}"

  phase "Phase 3 — systemd hardening"
  apply_systemd_limits "$TARGET_NOFILE"
  ok "systemd LimitNOFILE=${TARGET_NOFILE}"

  phase "Phase 4 — Write HAProxy config"
  backup_cfg
  port_conflict_check
  write_cfg "$NBTHREAD" "$MAXCONN" "$CPU_MAP_LINE"

  if ! validate_cfg; then
    warn "haproxy -c failed (likely cpu-map unsupported). Retrying without cpu-map…"
    write_cfg "$NBTHREAD" "$MAXCONN" ""
    validate_cfg || die "haproxy config invalid even without cpu-map. Check ${CFG}"
  fi
  ok "wrote config: ${CFG}"

  phase "Phase 5 — Start + Verify"
  start_haproxy
  sleep 1

  if ! systemctl is-active --quiet haproxy; then
    err "haproxy failed to start. Showing status/logs:"
    systemctl --no-pager -l status haproxy || true
    journalctl -u haproxy -n 120 --no-pager || true
    exit 1
  fi

  if verify_listen; then
    ok "MID is listening on ${BIND_ADDR}:${PORT}"
  else
    warn "No LISTEN found on :${PORT}. Possible conflict or bind mismatch."
    systemctl --no-pager -l status haproxy || true
    journalctl -u haproxy -n 120 --no-pager || true
    exit 1
  fi

  _hr
  ok "DONE — MID pass-through is ready"
  printf "%s%sClient → IRAN:%s → (SSH) → MID:%s → OUT:%s → Xray%s\n" \
    "${SILVER}${DIM}" "" "${PORT}" "${PORT}" "${PORT}" "${RESET}"
  _hr
  echo "Useful:"
  echo "  cat /etc/haproxy/haproxy.cfg"
  echo "  systemctl status haproxy --no-pager -l"
  echo "  journalctl -u haproxy -n 120 --no-pager"
}

main "$@"
