#!/usr/bin/env bash
set -euo pipefail

# ============================================================
# HUNTEX FINAL OPTIMIZER (GitHub Edition)
# Purpose:
#   - Safe sysctl tuning for tunnel-heavy setups (AutoSSH / WG / NAT)
#   - No vendor file modifications (does NOT touch /usr/lib/sysctl.d/*)
#   - Optional conntrack enablement for NAT-heavy hosts
#   - Optional systemd hardening for huntex-autossh-tunnel.service
#
# Notes:
#   - Improves stability/throughput; cannot beat physical latency distance.
#   - Idempotent: safe to run multiple times.
# ============================================================

# ---------- Colors (Mustard + Silver) ----------
# Mustard: RGB(204,153,0)   Silver: RGB(192,192,192)
C_MUSTARD=$'\033[38;2;204;153;0m'
C_SILVER=$'\033[38;2;192;192;192m'
C_DIM=$'\033[2m'
C_BOLD=$'\033[1m'
C_RESET=$'\033[0m'

banner() { echo -e "${C_MUSTARD}${C_BOLD}==>${C_RESET} ${C_SILVER}$*${C_RESET}"; }
step()   { echo -e "${C_SILVER}${C_DIM}[*]${C_RESET} ${C_SILVER}$*${C_RESET}"; }
ok()     { echo -e "${C_MUSTARD}${C_BOLD}==>${C_RESET} ${C_SILVER}$*${C_RESET}"; }

banner "HUNTEX FINAL OPTIMIZER started"

# ---------- 0) Basics ----------
export DEBIAN_FRONTEND=noninteractive
step "Installing minimal dependencies (best-effort)"
apt-get update -y >/dev/null 2>&1 || true
apt-get install -y iproute2 iptables kmod >/dev/null 2>&1 || true

# ---------- 1) sysctl tuning (safe for tunnel/WG/NAT) ----------
CONF="/etc/sysctl.d/99-huntex-optimizer.conf"

step "Writing sysctl tuning -> ${CONF}"
cat > "${CONF}" <<'SYS'
# =============================
# HUNTEX FINAL OPTIMIZER
# =============================
# Goals:
#   - Improve throughput and reduce stalls (BBR + FQ)
#   - Stabilize tunnels (keepalive tuning)
#   - NAT/WireGuard routing sanity (ip_forward + rp_filter loose)
#   - More headroom for bursts (backlogs)
#   - Larger conntrack table for NAT-heavy workloads (if loaded)
#
# Safety:
#   - Avoids noisy/unsupported keys (no accept_source_route/promote_secondaries)
#   - Writes only into /etc/sysctl.d (no vendor file edits)

# --- Queueing + Congestion Control ---
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr

# --- Socket buffers (reasonable, safe) ---
net.core.rmem_max = 33554432
net.core.wmem_max = 33554432
net.ipv4.tcp_rmem = 4096 87380 33554432
net.ipv4.tcp_wmem = 4096 65536 33554432

# --- Keep tunnel connections stable ---
net.ipv4.tcp_keepalive_time = 60
net.ipv4.tcp_keepalive_intvl = 10
net.ipv4.tcp_keepalive_probes = 6

# --- Reduce stalls / recovery behavior ---
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_mtu_probing = 1
net.ipv4.tcp_fin_timeout = 15

# --- Backlogs / bursts ---
net.core.somaxconn = 4096
net.core.netdev_max_backlog = 16384
net.ipv4.tcp_max_syn_backlog = 8192

# --- Low-risk TCP options ---
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_sack = 1
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_fastopen = 3

# --- Routing for NAT/WireGuard ---
net.ipv4.ip_forward = 1

# Loose RPF is recommended for asymmetric routing common with WG/NAT.
net.ipv4.conf.all.rp_filter = 2
net.ipv4.conf.default.rp_filter = 2

# --- Conntrack (effective only if nf_conntrack is loaded) ---
net.netfilter.nf_conntrack_max = 262144
SYS

step "Applying sysctl (sysctl --system)"
sysctl --system >/dev/null 2>&1 || true

# ---------- 2) Ensure conntrack module ----------
step "Ensuring nf_conntrack module is loaded (best-effort)"
modprobe nf_conntrack >/dev/null 2>&1 || true
mkdir -p /etc/modules-load.d
echo "nf_conntrack" > /etc/modules-load.d/nf_conntrack.conf

# Apply conntrack value explicitly if key exists after module load.
if sysctl -n net.netfilter.nf_conntrack_max >/dev/null 2>&1; then
  sysctl -w net.netfilter.nf_conntrack_max=262144 >/dev/null 2>&1 || true
fi

# ---------- 3) systemd hardening (if service exists) ----------
UNIT_NAME="huntex-autossh-tunnel.service"
if systemctl list-unit-files | grep -q "^${UNIT_NAME}"; then
  banner "Tuning ${UNIT_NAME} (NOFILE + restart policy)"
  mkdir -p "/etc/systemd/system/${UNIT_NAME}.d"

  cat > "/etc/systemd/system/${UNIT_NAME}.d/99-huntex.conf" <<'UNIT'
[Service]
LimitNOFILE=1048576
Restart=always
RestartSec=5
StartLimitIntervalSec=0
UNIT

  systemctl daemon-reload
  systemctl restart "${UNIT_NAME}" >/dev/null 2>&1 || true
else
  step "${UNIT_NAME} not found (OK on RU or hosts without AutoSSH)"
fi

# ---------- 4) Summary ----------
banner "SUMMARY"
echo -e "${C_SILVER}- sysctl file:${C_RESET} ${CONF}"
echo -e "${C_SILVER}- bbr:${C_RESET}  $(sysctl -n net.ipv4.tcp_congestion_control 2>/dev/null || echo '?')"
echo -e "${C_SILVER}- qdisc:${C_RESET} $(sysctl -n net.core.default_qdisc 2>/dev/null || echo '?')"
echo -e "${C_SILVER}- ip_forward:${C_RESET} $(sysctl -n net.ipv4.ip_forward 2>/dev/null || echo '?')"
echo -e "${C_SILVER}- rp_filter(all):${C_RESET} $(sysctl -n net.ipv4.conf.all.rp_filter 2>/dev/null || echo '?')"

if lsmod | grep -q '^nf_conntrack'; then
  echo -e "${C_SILVER}- conntrack loaded:${C_RESET} YES"
else
  echo -e "${C_SILVER}- conntrack loaded:${C_RESET} NO"
fi

if sysctl -n net.netfilter.nf_conntrack_max >/dev/null 2>&1; then
  echo -e "${C_SILVER}- nf_conntrack_max:${C_RESET} $(sysctl -n net.netfilter.nf_conntrack_max 2>/dev/null || echo 'N/A')"
else
  echo -e "${C_SILVER}- nf_conntrack_max:${C_RESET} N/A"
fi

pid="$(pgrep -xo autossh 2>/dev/null || true)"
echo -e "${C_SILVER}- autossh PID:${C_RESET} ${pid:-NONE}"
if [ -n "${pid:-}" ] && [ -r "/proc/${pid}/limits" ]; then
  echo -e "${C_SILVER}- autossh Max open files:${C_RESET}"
  grep -i "Max open files" "/proc/${pid}/limits" || true
fi

ok "DONE"
