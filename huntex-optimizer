#!/usr/bin/env bash
set -euo pipefail

# ============================================================
# HUNTEX FINAL OPTIMIZER (GitHub Edition)
# Purpose:
#   - Safe sysctl tuning for tunnel-heavy setups (AutoSSH / WG / NAT)
#   - No vendor file modifications (does NOT touch /usr/lib/sysctl.d/*)
#   - Optional conntrack enablement for NAT-heavy hosts
#   - Optional systemd hardening for huntex-autossh-tunnel.service
#
# Scenario (typical):
#   Iran nodes: inbound :443 -> AutoSSH to RU
#   RU node: WireGuard peers + DNAT to foreign nodes
#
# Notes:
#   - This optimizer improves stability and reduces stalls, but it cannot
#     "magically" reduce physical latency (ping) beyond network distance.
#   - Designed to be idempotent and safe to run multiple times.
# ============================================================

# ---------- Colors (Mustard) ----------
# Mustard-ish: RGB(204,153,0)
MUSTARD=$'\033[38;2;204;153;0m'
DIM=$'\033[2m'
RESET=$'\033[0m'

log()   { echo -e "${MUSTARD}==>${RESET} $*"; }
info()  { echo -e "${MUSTARD}${DIM}[*]${RESET} $*"; }
warn()  { echo -e "${MUSTARD}${DIM}[!]${RESET} $*"; }

log "HUNTEX FINAL OPTIMIZER started"

# ---------- 0) Basics ----------
export DEBIAN_FRONTEND=noninteractive
info "Installing minimal dependencies (best-effort)"
apt-get update -y >/dev/null 2>&1 || true
apt-get install -y iproute2 iptables kmod >/dev/null 2>&1 || true

# ---------- 1) sysctl tuning (safe for tunnel/WG/NAT) ----------
CONF="/etc/sysctl.d/99-huntex-optimizer.conf"

info "Writing sysctl tuning -> ${CONF}"
cat > "${CONF}" <<'SYS'
# =============================
# HUNTEX FINAL OPTIMIZER
# =============================
# Goals:
#   - Improve throughput and reduce stalls on long/loaded paths (BBR + FQ)
#   - Keep tunnels stable (keepalive tuning)
#   - Make NAT/WireGuard routing behave (ip_forward + rp_filter loose mode)
#   - Increase queue/backlog headroom
#   - Increase conntrack table size for NAT-heavy workloads (if conntrack is loaded)
#
# Safety:
#   - Avoids noisy / unsupported keys (no accept_source_route/promote_secondaries)
#   - Only writes into /etc/sysctl.d (no vendor file changes)

# --- Queueing + Congestion Control ---
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr

# --- Socket buffers (reasonable, safe) ---
net.core.rmem_max = 33554432
net.core.wmem_max = 33554432
net.ipv4.tcp_rmem = 4096 87380 33554432
net.ipv4.tcp_wmem = 4096 65536 33554432

# --- Keep tunnel connections stable ---
net.ipv4.tcp_keepalive_time = 60
net.ipv4.tcp_keepalive_intvl = 10
net.ipv4.tcp_keepalive_probes = 6

# --- Reduce stalls / recovery behavior ---
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_mtu_probing = 1
net.ipv4.tcp_fin_timeout = 15

# --- Backlogs / bursts ---
net.core.somaxconn = 4096
net.core.netdev_max_backlog = 16384
net.ipv4.tcp_max_syn_backlog = 8192

# --- Low-risk TCP options ---
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_sack = 1
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_fastopen = 3

# --- Routing for NAT/WireGuard ---
net.ipv4.ip_forward = 1

# Loose RPF is recommended for asymmetric routing common with WG/NAT.
# (1=strict may drop legitimate packets; 2=loose is usually correct here)
net.ipv4.conf.all.rp_filter = 2
net.ipv4.conf.default.rp_filter = 2

# --- Conntrack (effective only if nf_conntrack is loaded) ---
net.netfilter.nf_conntrack_max = 262144
SYS

info "Applying sysctl (sysctl --system)"
sysctl --system >/dev/null 2>&1 || true

# ---------- 2) Ensure conntrack module (useful on RU; harmless elsewhere) ----------
# Some minimal cloud images don't load conntrack by default.
# We load it now and persist module load for future boots.
info "Ensuring nf_conntrack module is loaded (best-effort)"
modprobe nf_conntrack >/dev/null 2>&1 || true
mkdir -p /etc/modules-load.d
echo "nf_conntrack" > /etc/modules-load.d/nf_conntrack.conf

# Apply conntrack value explicitly if key exists after module load.
if sysctl -n net.netfilter.nf_conntrack_max >/dev/null 2>&1; then
  sysctl -w net.netfilter.nf_conntrack_max=262144 >/dev/null 2>&1 || true
fi

# ---------- 3) systemd hardening for huntex autossh service (if present) ----------
# Fixes:
#   - "Too many open files" under high connection churn
#   - Flappy restart policies / start-limit exhaustion
UNIT_NAME="huntex-autossh-tunnel.service"

if systemctl list-unit-files | grep -q "^${UNIT_NAME}"; then
  log "Tuning ${UNIT_NAME} (NOFILE + restart policy)"
  mkdir -p "/etc/systemd/system/${UNIT_NAME}.d"

  cat > "/etc/systemd/system/${UNIT_NAME}.d/99-huntex.conf" <<'UNIT'
[Service]
LimitNOFILE=1048576
Restart=always
RestartSec=5
StartLimitIntervalSec=0
UNIT

  systemctl daemon-reload
  systemctl restart "${UNIT_NAME}" >/dev/null 2>&1 || true
else
  info "${UNIT_NAME} not found (OK on RU or hosts without AutoSSH)"
fi

# ---------- 4) Summary ----------
log "SUMMARY"
echo -e "${MUSTARD}- sysctl file:${RESET} ${CONF}"
echo -e "${MUSTARD}- bbr:${RESET} $(sysctl -n net.ipv4.tcp_congestion_control 2>/dev/null || echo '?')"
echo -e "${MUSTARD}- qdisc:${RESET} $(sysctl -n net.core.default_qdisc 2>/dev/null || echo '?')"
echo -e "${MUSTARD}- ip_forward:${RESET} $(sysctl -n net.ipv4.ip_forward 2>/dev/null || echo '?')"
echo -e "${MUSTARD}- rp_filter(all):${RESET} $(sysctl -n net.ipv4.conf.all.rp_filter 2>/dev/null || echo '?')"

if lsmod | grep -q '^nf_conntrack'; then
  echo -e "${MUSTARD}- conntrack loaded:${RESET} YES"
else
  echo -e "${MUSTARD}- conntrack loaded:${RESET} NO"
fi

if sysctl -n net.netfilter.nf_conntrack_max >/dev/null 2>&1; then
  echo -e "${MUSTARD}- nf_conntrack_max:${RESET} $(sysctl -n net.netfilter.nf_conntrack_max 2>/dev/null || echo 'N/A')"
else
  echo -e "${MUSTARD}- nf_conntrack_max:${RESET} N/A (kernel/module not exposing key)"
fi

pid="$(pgrep -xo autossh 2>/dev/null || true)"
echo -e "${MUSTARD}- autossh PID:${RESET} ${pid:-NONE}"
if [ -n "${pid:-}" ] && [ -r "/proc/${pid}/limits" ]; then
  echo -e "${MUSTARD}- autossh Max open files:${RESET}"
  grep -i "Max open files" "/proc/${pid}/limits" || true
fi

log "DONE"
